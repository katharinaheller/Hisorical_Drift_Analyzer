version: "3.9"

services:
  app:
    build: .
    container_name: hda-app
    volumes:
      - .:/workspace
    working_dir: /workspace
    command: bash -c "poetry install && poetry run python -m src.core.main_orchestrator --phase all"
    ports:
      - "8000:8000"
    environment:
      - PYTHONUNBUFFERED=1
    depends_on:
      - ollama
      - jupyterhub

  ollama:
    image: ollama/ollama:latest
    container_name: ollama
    volumes:
      - ollama_data:/root/.ollama
    ports:
      - "11434:11434"
    environment:
      - OLLAMA_MODELS=/root/.ollama/models
    restart: unless-stopped

  jupyterhub:
    image: jupyterhub/jupyterhub:latest
    container_name: jupyterhub
    volumes:
      - ./jupyterhub_config.py:/srv/jupyterhub/jupyterhub_config.py
      - ./notebooks:/home/jovyan
    ports:
      - "8888:8888"
    depends_on:
      - app
    restart: unless-stopped

volumes:
  ollama_data:
